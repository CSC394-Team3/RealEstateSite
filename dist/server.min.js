"use strict";var express=require("express"),app=express(),bodyParser=require("body-parser"),port=process.env.PORT||3e3,router=express.Router(),path=require("path"),pg=require("pg"),bcrypt=require("bcrypt"),_require=require("express-validator"),body=_require.body,validationResult=_require.validationResult;app.use(express.static(path.join(__dirname,"public"))),app.set("view engine","pug");var addressID,current_username="",current_realtorID=2,realtor=!0;app.use(bodyParser.json()),app.use(express.json()),app.use(bodyParser.urlencoded({extended:!0}));var Pool=require("pg").Pool,connectionParams=null;connectionParams=null!=process.env.DATABASE_URL?{connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}}:{host:"willowrealestate.postgres.database.azure.com",user:"team5",password:"Willow5!",database:"postgres",port:5432,ssl:!0},console.log(connectionParams);var pool=new pg.Client(connectionParams);pool.connect(function(r){if(r)throw r}),router.get("/",function(r,e){e.render("index",{title:"Willow"})}),router.post("/",function(r,e){var o=validationResult(r);if(!o.isEmpty())return e.status(400).send({errors:o.array()});e.redirect("/")}),router.get("/insert",function(r,o){pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID",function(r,e){console.log(r,e),o.render("insert",{properties:e.rows})})}),router.post("/insert",function(t,n){if(t.body.action&&"add"==t.body.action){var r="INSERT INTO address (street, city, state, zip) VALUES ( '".concat(t.body.street,"', '").concat(t.body.city,"', '").concat(t.body.state,"', '").concat(t.body.zip,"' ) ON conflict do nothing RETURNING  addressID");pool.query(r,function(r,e){if(e){addressID=e.rows[0].addressid,console.log(r,e);var o="INSERT INTO property (propertyType, price, size, num_bedroom, num_bathroom,realtorID, addressID) VALUES ('".concat(t.body.propertytype,"', '").concat(t.body.price,"','").concat(t.body.size,"','").concat(t.body.num_bedroom,"','").concat(t.body.num_bathroom,"','").concat(current_realtorID,"', '").concat(addressID,"')");pool.query(o,function(r,e){console.log(r,e),n.redirect("/insert")})}});var e="INSERT INTO property (propertyType, price, size, num_bedroom, num_bathroom,realtorID, addressID) VALUES ('".concat(t.body.propertytype,"', '").concat(t.body.price,"','").concat(t.body.size,"','").concat(t.body.num_bedroom,"','").concat(t.body.num_bathroom,"','").concat(current_realtorID,"', '").concat(addressID,"')");pool.query(e,function(r,e){console.log(r,e),n.redirect("/insert")})}if(t.body.action&&"update"==t.body.action){var o="UPDATE address SET street = '".concat(t.body.street,"', city = '").concat(t.body.city,"', state = '").concat(t.body.state,"', zip = '").concat(t.body.zip,"' RETURNING addressID");pool.query(o,function(r,e){if(0!=e.rows.length){addressID=e.rows[0].addressid;var o="UPDATE property SET propertyType = '".concat(t.body.propertytype,"', price = '").concat(t.body.price,"', size='").concat(t.body.size,"', num_bedroom = '").concat(t.body.num_bedroom,"', num_bathroom = '").concat(t.body.num_bathroom,"' WHERE addressID = '").concat(addressID,"'");pool.query(o,function(r,e){console.log(r,e),n.redirect("/insert")})}})}t.body.action&&"delete"==t.body.action&&pool.query("DELETE FROM property WHERE addressID = '".concat(addressID,"'"),function(r,e){console.log(r,e),n.redirect("/insert")})}),router.get("/register",function(r,e){e.render("register")}),router.post("/register",function(r,e){r.body.action&&"customer"==r.body.action&&(realtor=!1,e.redirect("/customersignup")),r.body.action&&"realtor"==r.body.action&&(realtor=!0,e.redirect("/realtorsignup"))}),router.get("/customersignup",function(r,e){e.render("customersignup")}),router.post("/customersignup",function(o,t){var e;return regeneratorRuntime.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(o.body.username&&o.body.password&&o.body.firstName&&o.body.lastName&&o.body.phoneno&&o.body.email){r.next=4;break}t.redirect("/customersignuperror"),r.next=8;break;case 4:return r.next=6,regeneratorRuntime.awrap(bcrypt.hash(o.body.password,10));case 6:e=r.sent,pool.query("INSERT INTO customer(user_name,password,first_name,last_name,phone_number,email)\n\t\tVALUES ( '".concat(o.body.username,"', '").concat(e,"', '").concat(o.body.firstName,"', '").concat(o.body.lastName,"', '").concat(o.body.phoneno,"', '").concat(o.body.email,"' ) "),function(r,e){current_username=o.body.username,t.redirect("/customerlogin")});case 8:case"end":return r.stop()}})}),router.get("/customersignuperror",function(r,e){e.render("customersignuperror")}),router.post("/customersignuperror",function(r,e){r.body.action&&"try again"==r.body.action&&e.redirect("/customersignup")}),router.get("/realtorsignup",function(r,e){e.render("realtorsignup")}),router.post("/realtorsignup",function(o,t){var e;return regeneratorRuntime.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(o.body.realtorID&&o.body.username&&o.body.password&&o.body.agency&&o.body.firstName&&o.body.lastName&&o.body.phoneno&&o.body.email){r.next=2;break}return r.abrupt("return",t.redirect("/realtorsignuperror"));case 2:return r.next=4,regeneratorRuntime.awrap(bcrypt.hash(o.body.password,10));case 4:e=r.sent,pool.query("INSERT INTO realtor(realtorID, user_name,password, agency, first_name,last_name,phone_number,email)\n\t\tVALUES ( '".concat(o.body.realtorID,"' ,'").concat(o.body.username,"', '").concat(e,"', '").concat(o.body.agency,"','").concat(o.body.firstName,"', '").concat(o.body.lastName,"', '").concat(o.body.phoneno,"', '").concat(o.body.email,"' ) \n\t "),function(r,e){current_realtorID=o.body.realtorID,current_username=o.body.username,t.redirect("/realtorlogin")});case 6:case"end":return r.stop()}})}),router.get("/realtorsignuperror",function(r,e){e.render("realtorsignuperror")}),router.post("/realtorsignuperror",function(r,e){r.body.action&&"try again"==r.body.action&&e.redirect("/realtorsignup")}),router.get("/invalid",function(r,e){e.render("invalidlogin")}),router.post("/invalid",function(r,e){realtor?e.redirect("/realtorlogin"):e.redirect("/customerlogin")}),router.get("/login",function(r,e){e.render("index")}),router.post("/login",function(r,e){r.body.action&&"customer"==r.body.action&&e.redirect("/customerlogin"),r.body.action&&"realtor"==r.body.action&&e.redirect("/realtorlogin")}),router.get("/customerlogin",function(r,e){e.render("customerlogin")}),router.post("/customerlogin",function(t,n){realtor=!1,t.body.action&&"login"==t.body.action&&(current_username=t.body.username,pool.query("SELECT * FROM CUSTOMER WHERE user_name = '".concat(t.body.username,"'"),function(r,e){if(console.log(r,e),0==e.rows.length&&n.redirect("/nocustomer"),0<e.rows.length){var o=e.rows[0].password;bcrypt.compareSync(t.body.password,o)?n.redirect("/customerpanel"):(n.redirect("/invalid"),console.log(t))}})),t.body.action&&"register"==t.body.action&&n.redirect("/register")}),router.get("/nocustomer",function(r,e){e.render("nocustomer")}),router.post("/nocustomer",function(r,e){r.body.action&&"try again"==r.body.action&&e.redirect("/customerlogin"),r.body.action&&"register"==r.body.action&&e.redirect("/customersignup")}),router.get("/norealtor",function(r,e){e.render("norealtor")}),router.post("/norealtor",function(r,e){r.body.action&&"try again"==r.body.action&&e.redirect("/realtorlogin"),r.body.action&&"register"==r.body.action&&e.redirect("/realtorsignup")}),router.get("/realtorlogin",function(r,e){e.render("realtorlogin")}),router.post("/realtorlogin",function(t,n){realtor=!0,t.body.action&&"login"==t.body.action&&(current_username=t.body.username,pool.query("SELECT * FROM realtor WHERE user_name = '".concat(t.body.username,"'"),function(r,e){if(console.log(r,e),0==e.rows.length&&n.redirect("/norealtor"),0<e.rows.length){var o=e.rows[0].password;bcrypt.compareSync(t.body.password,o)?(current_realtorID=e.rows[0].realtorID,n.redirect("/realtorpanel")):(n.redirect("/invalid"),console.log(t))}})),t.body.action&&"register"==t.body.action&&n.redirect("/register")}),router.get("/realtorpanel",function(r,o){pool.query("SELECT * FROM realtor WHERE user_name = '".concat(current_username,"'"),function(r,e){console.log(r,e),o.render("realtorpanel",{name:current_username,realtor:e.rows[0]})})}),router.post("/realtorpanel",function(r,e){r.body.action&&"crud"==r.body.action&&e.redirect("/insert"),r.body.action&&"change password"==r.body.action&&e.redirect("/realtorchangepassword"),r.body.action&&"change password"==r.body.action&&e.redirect("/realtorchangephoneno"),r.body.action&&"change email"==r.body.action&&e.redirect("/realtorchangeemail"),r.body.action&&"change agency"==r.body.action&&e.redirect("/realtorchangeagency"),r.body.action&&"change phone number"==r.body.action&&e.redirect("/realtorchangephoneno"),r.body.action&&"go to listings"==r.body.action&&e.redirect("/listingsr")}),router.get("/listingsr",function(r,o){pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID WHERE realtorID = '".concat(current_realtorID,"' "),function(r,e){console.log(r,e),o.render("listingsr",{properties:e.rows})})}),router.post("/listingsr",function(r,o){r.body.action&&"Order by Housing Type"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY propertytype",function(r,e){o.render("listingsr",{properties:e.rows})}):r.body.action&&"Order by Price"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY price",function(r,e){o.render("listingsr",{properties:e.rows})}):r.body.action&&"Order by Number of Bedrooms"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY num_bedroom",function(r,e){o.render("listingsr",{properties:e.rows})}):r.body.action&&"Order by Number of Bathrooms"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY num_bathroom",function(r,e){o.render("listingsr",{properties:e.rows})}):r.body.action&&"Order by Zip Code"==r.body.action&&pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY zip",function(r,e){o.render("listingsr",{properties:e.rows})})}),router.get("/realtorchangeagency",function(r,e){e.render("realtorchangeagency")}),router.post("/realtorchangeagency",function(r,e){pool.query("UPDATE realtor SET agency = '".concat(r.body.agency,"' WHERE user_name = '").concat(current_username,"' ")),e.redirect("/realtorpanel")}),router.get("/realtorchangepassword",function(r,e){e.render("realtorchangepassword")}),router.post("/realtorchangepassword",function(r,e){pool.query("UPDATE realtor SET password = '".concat(r.body.password,"' WHERE user_name = '").concat(current_username,"' ")),e.redirect("/realtorpanel")}),router.get("/realtorchangeemail",function(r,e){e.render("realtorchangeemail")}),router.post("/realtorchangeemail",function(r,e){pool.query("UPDATE realtor SET email = '".concat(r.body.email,"' WHERE user_name = '").concat(current_username,"' ")),e.redirect("/realtorpanel")}),router.get("/realtorchangephoneno",function(r,e){e.render("realtorchangephoneno")}),router.post("/realtorchangephoneno",function(r,e){pool.query("UPDATE realtor SET phone_number = '".concat(r.body.phoneno,"' WHERE user_name = '").concat(current_username,"' ")),e.redirect("/realtorpanel")}),router.get("/customerpanel",function(r,o){pool.query("SELECT * FROM customer WHERE user_name = '".concat(current_username,"'"),function(r,e){console.log(r,e),o.render("customerpanel",{name:current_username,customer:e.rows[0]})})}),router.post("/customerpanel",function(r,e){r.body.action&&"change password"==r.body.action&&e.redirect("/customerchangepassword"),r.body.action&&"change password"==r.body.action&&e.redirect("/customerchangephoneno"),r.body.action&&"change email"==r.body.action&&e.redirect("/customerchangeemail"),r.body.action&&"change phone number"==r.body.action&&e.redirect("/customerchangephoneno"),r.body.action&&"go to listings"==r.body.action&&e.redirect("/listingsc")}),router.get("/listingsc",function(r,o){pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID",function(r,e){console.log(r,e),o.render("listingsc",{properties:e.rows})})}),router.post("/listingsc",function(r,o){r.body.action&&"Order by Housing Type"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY propertytype",function(r,e){o.render("listingsc",{properties:e.rows})}):r.body.action&&"Order by Price"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY price",function(r,e){o.render("listingsc",{properties:e.rows})}):r.body.action&&"Order by Number of Bedrooms"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY num_bedroom",function(r,e){o.render("listingsc",{properties:e.rows})}):r.body.action&&"Order by Number of Bathrooms"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY num_bathroom",function(r,e){o.render("listingsc",{properties:e.rows})}):r.body.action&&"Order by Zip Code"==r.body.action?pool.query("SELECT * FROM property INNER JOIN address on address.addressID = property.addressID ORDER BY zip",function(r,e){o.render("listingsc",{properties:e.rows})}):r.body.action&&"Contact Us"==r.body.action&&o.redirect("/contactus")}),router.get("/contactus",function(r,e){e.render("contactus")}),router.post("/contactus",function(r,e){r.body.action&&"done"==r.body.action&&e.redirect("messagesent")}),router.get("/messagesent",function(r,e){e.render("messagesent")}),router.post("/messagesent",function(r,e){r.body.action&&"Go back to listings"==r.body.action&&e.redirect("/listingsc")}),router.get("/customerchangepassword",function(r,e){e.render("customerchangepassword")}),router.post("/customerchangepassword",function(r,e){pool.query("UPDATE customer SET password = '".concat(r.body.password,"' WHERE user_name = '").concat(current_username,"' ")),e.redirect("/customerpanel")}),router.get("/customerchangeemail",function(r,e){e.render("customerchangeemail")}),router.post("/customerchangeemail",function(r,e){pool.query("UPDATE customer SET email = '".concat(r.body.email,"' WHERE user_name = '").concat(current_username,"' ")),e.redirect("/customerpanel")}),router.get("/customerchangephoneno",function(r,e){e.render("customerchangephoneno")}),router.post("/customerchangephoneno",function(r,e){pool.query("UPDATE customer SET phone_number = '".concat(r.body.phoneno,"' WHERE user_name = '").concat(current_username,"' ")),e.redirect("/customerpanel")}),app.use("/",router),module.exports=app;
//# sourceMappingURL=server.min.js.map
